{% extends 'base.html' %}
{% load static %}
{% load form_tags %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/filters.css' %}">
<link rel="stylesheet" href="{% static 'css/cve_table.css' %}">
<main class="main-content" style="width:100%">

	<div class="filter-section">
		{% if heading == 'cve' %}
		<div class="filter-header">
			<h2>NIST CVE - Oslo kommune products</h2>
			<p style="text-align: center;">This page shows all newly published NIST vulnerabilities (CVE) last {{ number_days}} days with a score of {{cvss_limit}} or higher, combined with a <a href="{% url 'cve_keywords' %}">software or component</a> Oslo kommune has in production. You can also see <a href="{% url 'cve_without' %}">all vulnerabilities except tagged ones</a></p>
		</div>
		{% endif %}
		{% if heading == 'cve_without' %}
		<div class="filter-header">
			<h2>NIST CVE - Everything else</h2>
			<p style="text-align: center;">This page shows all newly published NIST vulnerabilities (CVE) last {{ number_days}} days with a score of {{cvss_limit}} or higher, where no match was made against Oslo kommunes products. You can also see <a href="{% url 'cve' %}"> vulnerabilities with match</a></p>
		</div>
		{% endif %}
	</div>


		{% for day in days %}
			<h2>{{ day.datetime|date:"d. F" }}</h2>
			<section class="vulnerabilities-list" id="latest">
			{% for cve in day.cves %}
				<article class="cve">
					 <div class="cve-header">
						<h3 class="cve-title"><a style="text-decoration: none; color: black;" target="_blank" href="https://nvd.nist.gov/vuln/detail/{{ cve.cve_id }}">{{ cve.cve_id }}</a></h3>
							<div class="cve-tags">
								{% if cve.known_exploited %}
									<div class="cve-tag known-exploited">Known Exploited</div>
								{% endif %}
								<div class="cve-tag cve-criticality {{ cve|get_criticality_level }}">
									{{ cve|get_criticality_level }} {{ cve.cvss_score }}
								</div>
							</div>
					</div>
					<!-- Check the length of the description and truncate if necessary -->
					<p class="cve-description">
						{{ cve.description|slice:":500" }}
						{% if cve.description|length > 500 %}
							<span class="ellipsis">...</span>
							<span class="more-text">{{ cve.description|slice:"500:" }}</span>
							<button class="view-more-btn" onclick="toggleDescription(this)">View More</button>
						{% endif %}
					</p>
					<div class="cve-details">
						<span>Published: {{ cve.published_date|date:"M d, Y" }}</span>
						<span>Last Modified: {{ cve.last_modified_date|date:"M d, Y" }}</span>
					</div>
					{% if cve.keywords %}
						<div class="cve-keywords">
							<a target="_blank" href="https://kartoteket.oslo.kommune.no/sok/?search_term={{cve.keywords}}">{{ cve.keywords }}</a>
						</div>
					{% endif %}
				</article>
			{% empty %}
				<p>No vulnerabilities found.</p>
			{% endfor %}
			</section>
		{% endfor %}



</main>


<script>

document.addEventListener('DOMContentLoaded', function() {
	var searchInput = document.getElementById('search-input');
	var cveArticles = document.querySelectorAll('.cve');
	var sortSelect = document.getElementById('sort-select');


	searchInput.addEventListener('keyup', function(e) {
		var searchTerm = e.target.value.toLowerCase();
		cveArticles.forEach(function(article) {
			var title = article.querySelector('.cve-title').textContent.toLowerCase();
			var description = article.querySelector('.cve-description').textContent.toLowerCase();
			if (title.includes(searchTerm) || description.includes(searchTerm)) {
				article.style.display = '';
			} else {
				article.style.display = 'none';
			}
		});
	});

	sortSelect.addEventListener('change', function(e) {
		var selectedOption = e.target.value;
		var queryParams = new URLSearchParams(window.location.search);

		// Update the 'sort_by' parameter based on the selected option
		queryParams.set('sort_by', selectedOption);

		// Update the page URL
		window.location.search = queryParams.toString();
	});

	// Handle date filter change
	var dateFilterSelect = document.getElementById('date-filter-select');
	dateFilterSelect.addEventListener('change', function(e) {
		var selectedOption = e.target.value;
		var queryParams = new URLSearchParams(window.location.search);

		// Update the 'date_filter' parameter based on the selected option
		queryParams.set('date_filter', selectedOption);

		// Update the page URL
		window.location.search = queryParams.toString();
	});

	var filterKeywordsCheckbox = document.getElementById('filter-keywords');
	filterKeywordsCheckbox.addEventListener('change', function(e) {
		var queryParams = new URLSearchParams(window.location.search);

		// Toggle the 'keywords' parameter based on checkbox state
		if (this.checked) {
			queryParams.set('keywords', 'true');
		} else {
			queryParams.delete('keywords');
		}

		// Prevent the default action to maintain the checkbox state until the page reloads
		e.preventDefault();

		// Update the page URL and reload
		window.location.search = queryParams.toString();
	});


	// Toggle view button
	var toggleViewBtn = document.getElementById('toggle-view-btn');
	var vulnerabilitiesList = document.querySelector('.vulnerabilities-list');
	var cveTable = document.querySelector('.cve-table');

	// Initially hide the table view
	cveTable.style.display = 'none';

	toggleViewBtn.addEventListener('click', function() {
		if (vulnerabilitiesList.style.display === 'none') {
			vulnerabilitiesList.style.display = '';
			cveTable.style.display = 'none';
			toggleViewBtn.textContent = 'Show Table View';
		} else {
			vulnerabilitiesList.style.display = 'none';
			cveTable.style.display = '';
			toggleViewBtn.textContent = 'Show List View';
		}
	});

});


</script>


{% endblock %}




